{% extends "base.html" %}

{% block title %}Panel Pracownika{% endblock %}

{% block content %}
<h1>Panel Pracownika</h1>

<div class="card">
    <h2>Informacje pracownika</h2>
    <div class="form-group">
        <label for="workerName">Imiƒô i nazwisko:</label>
        <input type="text" id="workerName" placeholder="Wprowad≈∫ swoje imiƒô i nazwisko">
    </div>
    
    <div class="form-group">
        <label for="stageSelect">Etap produkcji:</label>
        <select id="stageSelect">
            <option value="">Wybierz etap</option>
            {% for stage in stages %}
            <option value="{{ stage.id }}">{{ stage.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card">
    <h2>Skanuj kod QR</h2>
    <p class="text-muted">Wprowad≈∫ dane z kodu QR lub u≈ºyj kamery do skanowania</p>
    
    <div class="form-group">
        <label for="qrInput">Kod QR zlecenia:</label>
        <input type="text" id="qrInput" placeholder="ORDER:XXX lub skanuj kod QR">
    </div>
    
    <div class="form-group">
        <button id="scanBtn" class="btn btn-primary">üì∑ Skanuj kamerƒÖ</button>
        <button id="stopScanBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Zatrzymaj skanowanie</button>
    </div>
    
    <div id="qrReader" style="display: none; margin-top: 1rem;"></div>
    
    <div class="action-buttons">
        <button id="startBtn" class="btn btn-success">Start pracy</button>
        <button id="stopBtn" class="btn btn-danger">Stop pracy</button>
    </div>
    
    <div id="message" class="message"></div>
</div>

<div class="card">
    <h2>Aktywne sesje pracy</h2>
    <div id="activeSessions">
        <p class="text-muted">Wprowad≈∫ swoje imiƒô i nazwisko aby zobaczyƒá aktywne sesje</p>
    </div>
</div>

<script>
let currentWorkerName = '';
let checkInterval = null;
let html5QrcodeScanner = null;
let isScanning = false;

document.getElementById('workerName').addEventListener('input', (e) => {
    currentWorkerName = e.target.value;
    if (currentWorkerName) {
        loadActiveSessions();
        if (!checkInterval) {
            checkInterval = setInterval(loadActiveSessions, 30000); // Check every 30 seconds
        }
    } else {
        if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
        }
        document.getElementById('activeSessions').innerHTML = 
            '<p class="text-muted">Wprowad≈∫ swoje imiƒô i nazwisko aby zobaczyƒá aktywne sesje</p>';
    }
});

document.getElementById('startBtn').addEventListener('click', () => {
    processAction('start');
});

document.getElementById('stopBtn').addEventListener('click', () => {
    processAction('stop');
});

async function processAction(action) {
    const workerName = document.getElementById('workerName').value;
    const stageId = document.getElementById('stageSelect').value;
    const qrData = document.getElementById('qrInput').value;
    
    if (!workerName) {
        showMessage('Wprowad≈∫ imiƒô i nazwisko', 'error');
        return;
    }
    
    if (!stageId) {
        showMessage('Wybierz etap produkcji', 'error');
        return;
    }
    
    if (!qrData) {
        showMessage('Wprowad≈∫ lub zeskanuj kod QR', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                qr_data: qrData,
                worker_name: workerName,
                stage_id: stageId,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (action === 'start') {
                showMessage(`Rozpoczƒôto pracƒô nad zleceniem ${data.order_number} na etapie ${data.stage}`, 'success');
            } else {
                showMessage(`Zako≈Ñczono pracƒô. Czas trwania: ${data.duration_minutes} minut`, 'success');
            }
            document.getElementById('qrInput').value = '';
            loadActiveSessions();
        } else {
            showMessage(data.error || 'B≈ÇƒÖd podczas przetwarzania', 'error');
        }
    } catch (error) {
        showMessage('B≈ÇƒÖd komunikacji z serwerem', 'error');
    }
}

async function loadActiveSessions() {
    if (!currentWorkerName) return;
    
    try {
        const response = await fetch(`/api/worker/active-sessions?worker_name=${encodeURIComponent(currentWorkerName)}`);
        const sessions = await response.json();
        
        const container = document.getElementById('activeSessions');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p class="text-muted">Brak aktywnych sesji pracy</p>';
        } else {
            let html = '<table class="table"><thead><tr><th>Zlecenie</th><th>Etap</th><th>Czas rozpoczƒôcia</th></tr></thead><tbody>';
            sessions.forEach(session => {
                const startTime = new Date(session.start_time).toLocaleString('pl-PL');
                html += `<tr>
                    <td>${session.order_number}</td>
                    <td>${session.stage_name}</td>
                    <td>${startTime}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading active sessions:', error);
    }
}

function showMessage(msg, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = msg;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

// Allow Enter key on QR input for quick scanning
document.getElementById('qrInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('startBtn').click();
    }
});

// Camera QR scanning functionality
document.getElementById('scanBtn').addEventListener('click', () => {
    startQRScanner();
});

document.getElementById('stopScanBtn').addEventListener('click', () => {
    stopQRScanner();
});

function startQRScanner() {
    if (isScanning) return;
    
    // Check if Html5Qrcode library is loaded
    if (typeof Html5Qrcode === 'undefined') {
        showMessage('Biblioteka skanowania nie zosta≈Ça za≈Çadowana. Sprawd≈∫ po≈ÇƒÖczenie internetowe i od≈õwie≈º stronƒô. Je≈õli problem siƒô powtarza, u≈ºyj rƒôcznego wprowadzania kodu QR.', 'error');
        return;
    }
    
    const qrReaderDiv = document.getElementById('qrReader');
    qrReaderDiv.style.display = 'block';
    
    html5QrcodeScanner = new Html5Qrcode("qrReader");
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };
    
    html5QrcodeScanner.start(
        { facingMode: "environment" }, // Use back camera on mobile
        config,
        (decodedText, decodedResult) => {
            // QR code successfully scanned
            document.getElementById('qrInput').value = decodedText;
            showMessage('Kod QR zeskanowany pomy≈õlnie!', 'success');
            stopQRScanner();
        },
        (errorMessage) => {
            // Scanning error or no QR code detected - this is normal, ignore
        }
    ).then(() => {
        isScanning = true;
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';
    }).catch((err) => {
        showMessage('B≈ÇƒÖd uruchamiania kamery: ' + (err.message || err), 'error');
        qrReaderDiv.style.display = 'none';
    });
}

function stopQRScanner() {
    if (!isScanning || !html5QrcodeScanner) return;
    
    html5QrcodeScanner.stop().then(() => {
        resetScannerUI();
    }).catch((err) => {
        console.error('Error stopping scanner:', err);
        // Reset UI even if stopping fails
        resetScannerUI();
    });
}

function resetScannerUI() {
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.clear();
        } catch (err) {
            console.error('Error clearing scanner:', err);
        }
        html5QrcodeScanner = null;
    }
    isScanning = false;
    document.getElementById('qrReader').style.display = 'none';
    document.getElementById('scanBtn').style.display = 'inline-block';
    document.getElementById('stopScanBtn').style.display = 'none';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}
