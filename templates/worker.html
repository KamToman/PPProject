{% extends "base.html" %}

{% block title %}Panel Pracownika{% endblock %}

{% block content %}
<h1>Panel Pracownika</h1>

<div class="card">
    <h2>Informacje pracownika</h2>
    <div class="form-group">
        <label>Imiƒô i nazwisko:</label>
        <p style="padding: 0.75rem; background-color: #f8f9fa; border-radius: 5px; margin: 0.5rem 0;">
            <strong>{{ user.full_name }}</strong>
        </p>
        <input type="hidden" id="workerName" value="{{ user.full_name }}">
    </div>
    
    <div class="form-group">
        <label for="stageSelect">Etap produkcji:</label>
        <select id="stageSelect">
            <option value="">Wybierz etap</option>
            {% for stage in stages %}
            <option value="{{ stage.id }}">{{ stage.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card">
    <h2>Skanuj kod QR</h2>
    <p class="text-muted">Zeskanuj kod QR aby automatycznie rozpoczƒÖƒá lub zako≈Ñczyƒá pracƒô</p>
    
    <!-- Visual Status Indicator Banner -->
    <div id="statusBanner" style="display: none; padding: 1.5rem; margin: 1rem 0; border-radius: 10px; text-align: center; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); position: relative;">
        <button id="dismissBanner" style="position: absolute; top: 0.5rem; right: 0.5rem; background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.5rem; opacity: 0.8;" onclick="document.getElementById('statusBanner').style.display='none';">&times;</button>
        <div id="statusText"></div>
        <div id="statusDetails" style="font-size: 0.9rem; margin-top: 0.5rem; font-weight: normal;"></div>
    </div>
    
    <div class="form-group">
        <button id="startScanBtn" class="btn btn-primary">üì∑ Rozpocznij skanowanie</button>
        <button id="stopScanBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Zatrzymaj skanowanie</button>
    </div>
    
    <div id="qrReader" style="margin-top: 1rem;"></div>
    
    <div id="message" class="message"></div>
    
    <div style="margin-top: 1rem; padding: 0.75rem; background-color: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
        <strong>üí° Wskaz√≥wki dotyczƒÖce skanowania:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
            <li>Upewnij siƒô, ≈ºe kod QR jest dobrze o≈õwietlony</li>
            <li>Trzymaj kod QR w centrum niebieskiego kwadratu na ekranie</li>
            <li>Trzymaj kamerƒô stabilnie i w odleg≈Ço≈õci 10-30 cm od kodu</li>
            <li>Je≈õli nie skanuje, spr√≥buj zwiƒôkszyƒá lub zmniejszyƒá odleg≈Ço≈õƒá</li>
            <li>Upewnij siƒô, ≈ºe kod QR nie jest rozmazany ani uszkodzony</li>
        </ul>
    </div>
</div>

<div class="card">
    <h2>Aktywne sesje pracy</h2>
    <div id="activeSessions">
        <p class="text-muted">≈Åadowanie aktywnych sesji...</p>
    </div>
</div>

<script>
const SCAN_COOLDOWN_MS = 3000; // 3 seconds between scans

let currentWorkerName = '';
let checkInterval = null;
let html5QrcodeScanner = null;
let isScanning = false;
let scanCooldown = false;
let lastProcessedQR = '';
let lastProcessedTime = 0;

function setupEventListeners() {
    // Get worker name from logged-in user (stored in hidden field)
    const workerNameEl = document.getElementById('workerName');
    if (workerNameEl && workerNameEl.value) {
        currentWorkerName = workerNameEl.value;
        // Load active sessions immediately
        loadActiveSessions();
        // Set up periodic refresh of active sessions
        if (!checkInterval) {
            checkInterval = setInterval(loadActiveSessions, 30000); // Check every 30 seconds
        }
    }
    
    // Allow Enter key on QR input for quick scanning
    const qrInputEl = document.getElementById('qrInput');
    if (qrInputEl) {
        qrInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('startBtn').click();
            }
        });
    }
    
    // Camera QR scanning functionality
    const startScanBtnEl = document.getElementById('startScanBtn');
    if (startScanBtnEl) {
        startScanBtnEl.addEventListener('click', () => {
            startQRScanner();
        });
    }
    
    const stopScanBtnEl = document.getElementById('stopScanBtn');
    if (stopScanBtnEl) {
        stopScanBtnEl.addEventListener('click', () => {
            stopQRScanner();
        });
    }
}

async function processQRScan(qrData) {
    const now = Date.now();
    
    // Check if this is the same QR code scanned too recently
    if (lastProcessedQR === qrData && (now - lastProcessedTime) < SCAN_COOLDOWN_MS) {
        console.log('Scan ignored - same QR code within cooldown period');
        return;
    }
    
    // Prevent multiple rapid scans during cooldown period
    if (scanCooldown) {
        console.log('Scan blocked - cooldown active for different QR');
        return;
    }
    
    const workerName = document.getElementById('workerName').value.trim();
    const stageId = document.getElementById('stageSelect').value;
    
    if (!workerName) {
        showMessage('B≈ÇƒÖd: brak informacji o pracowniku', 'error');
        return;
    }
    
    if (!stageId) {
        showMessage('Wybierz etap produkcji przed skanowaniem', 'error');
        return;
    }
    
    // Set cooldown to prevent multiple scans
    scanCooldown = true;
    lastProcessedQR = qrData;
    lastProcessedTime = now;
    console.log('Processing QR code:', qrData, 'at', new Date(now).toISOString());
    
    // Update currentWorkerName to ensure consistency
    currentWorkerName = workerName;
    
    // Check if there's an active session for this order AND stage
    const activeSessions = await getActiveSessionsForWorker(workerName);
    console.log('Active sessions for worker:', activeSessions);
    console.log('Looking for QR:', qrData, 'Worker:', workerName, 'Stage:', stageId, '(as int:', parseInt(stageId), ')');
    
    const existingSession = activeSessions.find(session => {
        const matches = session.qr_data === qrData && 
                       session.worker_name === workerName && 
                       session.stage_id === parseInt(stageId);
        console.log('Checking session:', session, 'Matches:', matches);
        return matches;
    });
    
    const action = existingSession ? 'stop' : 'start';
    console.log('Existing session found:', existingSession);
    console.log('Action determined:', action);
    
    let success = false;
    
    try {
        const response = await fetch('/api/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                qr_data: qrData,
                worker_name: workerName,
                stage_id: stageId,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('Scan successful:', data);
            success = true;
            if (action === 'start') {
                showMessage(`‚úÖ Rozpoczƒôto pracƒô nad zleceniem ${data.order_number} na etapie ${data.stage}`, 'success');
                showStatusBanner('green', `üü¢ Praca w toku`, `Zlecenie: ${data.order_number} - Etap: ${data.stage}`);
            } else {
                showMessage(`‚èπÔ∏è Zako≈Ñczono pracƒô. Czas trwania: ${data.duration_minutes} minut`, 'success');
                showStatusBanner('red', `üî¥ Praca zako≈Ñczona`, `Czas trwania: ${data.duration_minutes} minut`);
            }
            loadActiveSessions();
        } else {
            console.error('Scan failed:', data);
            showMessage(data.error || 'B≈ÇƒÖd podczas przetwarzania', 'error');
        }
    } catch (error) {
        console.error('Scan error:', error);
        showMessage('B≈ÇƒÖd komunikacji z serwerem', 'error');
    } finally {
        // Clear cooldown - immediately on error, after delay on success
        if (success) {
            setTimeout(() => {
                scanCooldown = false;
                console.log('Cooldown cleared - ready for next scan');
            }, SCAN_COOLDOWN_MS);
        } else {
            scanCooldown = false;
            console.log('Cooldown cleared immediately due to error');
        }
    }
}

async function getActiveSessions() {
    if (!currentWorkerName) return [];
    return await getActiveSessionsForWorker(currentWorkerName);
}

async function getActiveSessionsForWorker(workerName) {
    if (!workerName) return [];
    
    try {
        const response = await fetch(`/api/worker/active-sessions?worker_name=${encodeURIComponent(workerName)}`);
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error fetching active sessions:', error);
    }
    return [];
}

async function loadActiveSessions() {
    if (!currentWorkerName) return;
    
    try {
        const response = await fetch(`/api/worker/active-sessions?worker_name=${encodeURIComponent(currentWorkerName)}`);
        const sessions = await response.json();
        
        const container = document.getElementById('activeSessions');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p class="text-muted">Brak aktywnych sesji pracy</p>';
        } else {
            let html = '<table class="table"><thead><tr><th>Zlecenie</th><th>Etap</th><th>Czas rozpoczƒôcia</th></tr></thead><tbody>';
            sessions.forEach(session => {
                const startTime = new Date(session.start_time).toLocaleString('pl-PL');
                html += `<tr>
                    <td>${session.order_number}</td>
                    <td>${session.stage_name}</td>
                    <td>${startTime}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading active sessions:', error);
    }
}

function showMessage(msg, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = msg;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

function showStatusBanner(color, mainText, detailsText) {
    const banner = document.getElementById('statusBanner');
    const statusText = document.getElementById('statusText');
    const statusDetails = document.getElementById('statusDetails');
    
    if (color === 'green') {
        banner.style.backgroundColor = '#27ae60';
        banner.style.color = 'white';
    } else if (color === 'red') {
        banner.style.backgroundColor = '#e74c3c';
        banner.style.color = 'white';
    }
    
    statusText.textContent = mainText;
    statusDetails.textContent = detailsText;
    banner.style.display = 'block';
    
    // Hide banner after 15 seconds (increased from 8 seconds)
    setTimeout(() => {
        banner.style.display = 'none';
    }, 15000);
}

function startQRScanner() {
    if (isScanning) return;
    
    // Check if Html5Qrcode library is loaded
    if (typeof Html5Qrcode === 'undefined') {
        showMessage('Biblioteka skanowania nie zosta≈Ça za≈Çadowana. Sprawd≈∫ po≈ÇƒÖczenie internetowe i od≈õwie≈º stronƒô.', 'error');
        return;
    }
    
    const qrReaderDiv = document.getElementById('qrReader');
    qrReaderDiv.style.display = 'block';
    
    html5QrcodeScanner = new Html5Qrcode("qrReader");
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        disableFlip: false  // Try both normal and flipped orientations
    };
    
    html5QrcodeScanner.start(
        { facingMode: "environment" }, // Use back camera on mobile
        config,
        (decodedText, decodedResult) => {
            // QR code successfully scanned - automatically process it
            processQRScan(decodedText);
        },
        (errorMessage) => {
            // Scanning error or no QR code detected - this is normal, ignore
        }
    ).then(() => {
        isScanning = true;
        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';
    }).catch((err) => {
        let errorMsg = 'B≈ÇƒÖd uruchamiania kamery: ';
        const errMessage = err.message || '';
        
        if (err.name === 'NotReadableError' || errMessage.includes('NotReadableError')) {
            errorMsg += 'Kamera jest ju≈º u≈ºywana przez innƒÖ aplikacjƒô lub kartƒô przeglƒÖdarki. Zamknij inne aplikacje u≈ºywajƒÖce kamery i od≈õwie≈º stronƒô.';
        } else if (err.name === 'NotAllowedError' || errMessage.includes('Permission denied')) {
            errorMsg += 'Brak dostƒôpu do kamery. Zezw√≥l na u≈ºycie kamery w ustawieniach przeglƒÖdarki i od≈õwie≈º stronƒô.';
        } else if (err.name === 'NotFoundError' || errMessage.includes('Requested device not found')) {
            errorMsg += 'Nie znaleziono kamery. Upewnij siƒô, ≈ºe urzƒÖdzenie ma pod≈ÇƒÖczonƒÖ kamerƒô.';
        } else {
            errorMsg += (err.message || err);
        }
        
        showMessage(errorMsg, 'error');
        qrReaderDiv.style.display = 'none';
        
        // Reset scanner state
        if (html5QrcodeScanner) {
            try {
                html5QrcodeScanner.clear();
            } catch (clearErr) {
                console.error('Error clearing scanner:', clearErr);
            }
            html5QrcodeScanner = null;
        }
        isScanning = false;
        
        // Show start button to allow manual retry
        document.getElementById('startScanBtn').style.display = 'inline-block';
        document.getElementById('stopScanBtn').style.display = 'none';
    });
}

function stopQRScanner() {
    if (!isScanning || !html5QrcodeScanner) return;
    
    html5QrcodeScanner.stop().then(() => {
        resetScannerUI();
    }).catch((err) => {
        console.error('Error stopping scanner:', err);
        // Reset UI even if stopping fails
        resetScannerUI();
    });
}

function resetScannerUI() {
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.clear();
        } catch (err) {
            console.error('Error clearing scanner:', err);
        }
        html5QrcodeScanner = null;
    }
    isScanning = false;
    document.getElementById('qrReader').style.display = 'block';
    document.getElementById('startScanBtn').style.display = 'inline-block';
    document.getElementById('stopScanBtn').style.display = 'none';
}

// Auto-start scanner after library loads with delay to ensure permissions
function initScanner() {
    if (typeof Html5Qrcode !== 'undefined') {
        // Hide start button initially while auto-starting
        document.getElementById('startScanBtn').style.display = 'none';
        
        // Add a small delay before auto-starting to allow page to fully load
        setTimeout(() => {
            startQRScanner();
        }, 500);
    } else {
        // Show start button if library takes too long to load
        setTimeout(() => {
            if (typeof Html5Qrcode === 'undefined') {
                document.getElementById('startScanBtn').style.display = 'inline-block';
                showMessage('≈Åadowanie biblioteki skanowania... Je≈õli trwa to d≈Çugo, sprawd≈∫ po≈ÇƒÖczenie internetowe.', 'info');
            }
        }, 3000);
        
        // Retry after a short delay if library not loaded yet
        setTimeout(initScanner, 100);
    }
}

// Initialize everything when DOM is ready
function initializePage() {
    setupEventListeners();
    initScanner();
}

// Start when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
} else {
    initializePage();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}
