{% extends "base.html" %}

{% block title %}Panel Pracownika{% endblock %}

{% block content %}
<h1>Panel Pracownika</h1>

<div class="card">
    <h2>Informacje pracownika</h2>
    <div class="form-group">
        <label for="workerName">Imiƒô i nazwisko:</label>
        <input type="text" id="workerName" placeholder="Wprowad≈∫ swoje imiƒô i nazwisko">
    </div>
    
    <div class="form-group">
        <label for="stageSelect">Etap produkcji:</label>
        <select id="stageSelect">
            <option value="">Wybierz etap</option>
            {% for stage in stages %}
            <option value="{{ stage.id }}">{{ stage.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card">
    <h2>Skanuj kod QR</h2>
    <p class="text-muted">Zeskanuj kod QR aby automatycznie rozpoczƒÖƒá lub zako≈Ñczyƒá pracƒô</p>
    
    <div class="form-group">
        <button id="startScanBtn" class="btn btn-primary" style="display: none;">üì∑ Rozpocznij skanowanie</button>
        <button id="stopScanBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Zatrzymaj skanowanie</button>
    </div>
    
    <div id="qrReader" style="margin-top: 1rem;"></div>
    
    <div id="message" class="message"></div>
</div>

<div class="card">
    <h2>Aktywne sesje pracy</h2>
    <div id="activeSessions">
        <p class="text-muted">Wprowad≈∫ swoje imiƒô i nazwisko aby zobaczyƒá aktywne sesje</p>
    </div>
</div>

<script>
let currentWorkerName = '';
let checkInterval = null;
let html5QrcodeScanner = null;
let isScanning = false;

function setupEventListeners() {
    const workerNameEl = document.getElementById('workerName');
    if (workerNameEl) {
        workerNameEl.addEventListener('input', (e) => {
            currentWorkerName = e.target.value;
            if (currentWorkerName) {
                loadActiveSessions();
                if (!checkInterval) {
                    checkInterval = setInterval(loadActiveSessions, 30000); // Check every 30 seconds
                }
            } else {
                if (checkInterval) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                }
                document.getElementById('activeSessions').innerHTML = 
                    '<p class="text-muted">Wprowad≈∫ swoje imiƒô i nazwisko aby zobaczyƒá aktywne sesje</p>';
            }
        });
    }
    
    // Allow Enter key on QR input for quick scanning
    const qrInputEl = document.getElementById('qrInput');
    if (qrInputEl) {
        qrInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('startBtn').click();
            }
        });
    }
    
    // Camera QR scanning functionality
    const startScanBtnEl = document.getElementById('startScanBtn');
    if (startScanBtnEl) {
        startScanBtnEl.addEventListener('click', () => {
            startQRScanner();
        });
    }
    
    const stopScanBtnEl = document.getElementById('stopScanBtn');
    if (stopScanBtnEl) {
        stopScanBtnEl.addEventListener('click', () => {
            stopQRScanner();
        });
    }
}

async function processQRScan(qrData) {
    const workerName = document.getElementById('workerName').value;
    const stageId = document.getElementById('stageSelect').value;
    
    if (!workerName) {
        showMessage('Wprowad≈∫ imiƒô i nazwisko przed skanowaniem', 'error');
        return;
    }
    
    if (!stageId) {
        showMessage('Wybierz etap produkcji przed skanowaniem', 'error');
        return;
    }
    
    // Check if there's an active session for this order
    const activeSessions = await getActiveSessions();
    const existingSession = activeSessions.find(session => {
        return session.qr_data === qrData && session.worker_name === workerName;
    });
    
    const action = existingSession ? 'stop' : 'start';
    
    try {
        const response = await fetch('/api/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                qr_data: qrData,
                worker_name: workerName,
                stage_id: stageId,
                action: action
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (action === 'start') {
                showMessage(`‚úÖ Rozpoczƒôto pracƒô nad zleceniem ${data.order_number} na etapie ${data.stage}`, 'success');
            } else {
                showMessage(`‚èπÔ∏è Zako≈Ñczono pracƒô. Czas trwania: ${data.duration_minutes} minut`, 'success');
            }
            loadActiveSessions();
        } else {
            showMessage(data.error || 'B≈ÇƒÖd podczas przetwarzania', 'error');
        }
    } catch (error) {
        showMessage('B≈ÇƒÖd komunikacji z serwerem', 'error');
    }
}

async function getActiveSessions() {
    if (!currentWorkerName) return [];
    
    try {
        const response = await fetch(`/api/worker/active-sessions?worker_name=${encodeURIComponent(currentWorkerName)}`);
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error fetching active sessions:', error);
    }
    return [];
}

async function loadActiveSessions() {
    if (!currentWorkerName) return;
    
    try {
        const response = await fetch(`/api/worker/active-sessions?worker_name=${encodeURIComponent(currentWorkerName)}`);
        const sessions = await response.json();
        
        const container = document.getElementById('activeSessions');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p class="text-muted">Brak aktywnych sesji pracy</p>';
        } else {
            let html = '<table class="table"><thead><tr><th>Zlecenie</th><th>Etap</th><th>Czas rozpoczƒôcia</th></tr></thead><tbody>';
            sessions.forEach(session => {
                const startTime = new Date(session.start_time).toLocaleString('pl-PL');
                html += `<tr>
                    <td>${session.order_number}</td>
                    <td>${session.stage_name}</td>
                    <td>${startTime}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading active sessions:', error);
    }
}

function showMessage(msg, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = msg;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

function startQRScanner() {
    if (isScanning) return;
    
    // Check if Html5Qrcode library is loaded
    if (typeof Html5Qrcode === 'undefined') {
        showMessage('Biblioteka skanowania nie zosta≈Ça za≈Çadowana. Sprawd≈∫ po≈ÇƒÖczenie internetowe i od≈õwie≈º stronƒô.', 'error');
        return;
    }
    
    const qrReaderDiv = document.getElementById('qrReader');
    qrReaderDiv.style.display = 'block';
    
    html5QrcodeScanner = new Html5Qrcode("qrReader");
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };
    
    html5QrcodeScanner.start(
        { facingMode: "environment" }, // Use back camera on mobile
        config,
        (decodedText, decodedResult) => {
            // QR code successfully scanned - automatically process it
            processQRScan(decodedText);
        },
        (errorMessage) => {
            // Scanning error or no QR code detected - this is normal, ignore
        }
    ).then(() => {
        isScanning = true;
        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';
    }).catch((err) => {
        let errorMsg = 'B≈ÇƒÖd uruchamiania kamery: ';
        
        if (err.name === 'NotReadableError' || err.message.includes('NotReadableError')) {
            errorMsg += 'Kamera jest ju≈º u≈ºywana przez innƒÖ aplikacjƒô lub kartƒô przeglƒÖdarki. Zamknij inne aplikacje u≈ºywajƒÖce kamery i od≈õwie≈º stronƒô.';
        } else if (err.name === 'NotAllowedError' || err.message.includes('Permission denied')) {
            errorMsg += 'Brak dostƒôpu do kamery. Zezw√≥l na u≈ºycie kamery w ustawieniach przeglƒÖdarki i od≈õwie≈º stronƒô.';
        } else if (err.name === 'NotFoundError' || err.message.includes('Requested device not found')) {
            errorMsg += 'Nie znaleziono kamery. Upewnij siƒô, ≈ºe urzƒÖdzenie ma pod≈ÇƒÖczonƒÖ kamerƒô.';
        } else {
            errorMsg += (err.message || err);
        }
        
        showMessage(errorMsg, 'error');
        qrReaderDiv.style.display = 'none';
        
        // Reset scanner state
        if (html5QrcodeScanner) {
            try {
                html5QrcodeScanner.clear();
            } catch (clearErr) {
                console.error('Error clearing scanner:', clearErr);
            }
            html5QrcodeScanner = null;
        }
        isScanning = false;
        
        // Show start button to allow manual retry
        document.getElementById('startScanBtn').style.display = 'inline-block';
        document.getElementById('stopScanBtn').style.display = 'none';
    });
}

function stopQRScanner() {
    if (!isScanning || !html5QrcodeScanner) return;
    
    html5QrcodeScanner.stop().then(() => {
        resetScannerUI();
    }).catch((err) => {
        console.error('Error stopping scanner:', err);
        // Reset UI even if stopping fails
        resetScannerUI();
    });
}

function resetScannerUI() {
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.clear();
        } catch (err) {
            console.error('Error clearing scanner:', err);
        }
        html5QrcodeScanner = null;
    }
    isScanning = false;
    document.getElementById('qrReader').style.display = 'block';
    document.getElementById('startScanBtn').style.display = 'inline-block';
    document.getElementById('stopScanBtn').style.display = 'none';
}

// Auto-start scanner after library loads with delay to ensure permissions
function initScanner() {
    if (typeof Html5Qrcode !== 'undefined') {
        // Add a small delay before auto-starting to allow page to fully load
        setTimeout(() => {
            startQRScanner();
        }, 500);
    } else {
        // Retry after a short delay if library not loaded yet
        setTimeout(initScanner, 100);
    }
}

// Initialize everything when DOM is ready
function initializePage() {
    setupEventListeners();
    initScanner();
}

// Start when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
} else {
    initializePage();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endblock %}
